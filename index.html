<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no">

<title>SENSE Dashboard</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: black;
  color: white;
  font-family: Arial, sans-serif;
  overflow: hidden;
}

/* Canvas */
canvas {
  position: fixed;
  inset: 0;
}

/* Connect button */
#connectBtn {
  position: fixed;
  top: calc(12px + env(safe-area-inset-top));
  left: 12px;
  z-index: 10;
  padding: 10px 16px;
  font-size: 14px;
}

/* Bottom motor bar */
#motorBar {
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(12px + env(safe-area-inset-bottom));
  display: flex;
  justify-content: center;
  z-index: 10;
}

#motorBtn {
  padding: 14px 30px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: rgb(40,120,40);
  color: white;
}
</style>
</head>

<body>

<button id="connectBtn">Connect BLE</button>

<canvas id="c"></canvas>

<div id="motorBar">
  <button id="motorBtn">PULSE MOTOR</button>
</div>

<script>
/* ================= BLE UUIDs ================= */
const SERVICE_UUID = "00001234-0000-1000-8000-00805f9b34fb";
const CHAR_UUID    = "00004567-0000-1000-8000-00805f9b34fb";

/* ================= Canvas ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ================= Data ================= */
let pkt = 0;

/* ================= BLE ================= */
let device = null;
let characteristic = null;

async function connectBLE() {
  try {
    console.log("Requesting device...");

    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    console.log("Selected:", device.name);

    device.addEventListener("gattserverdisconnected", () => {
      console.warn("BLE disconnected");
      alert("BLE disconnected");
    });

    console.log("Connecting GATT...");
    const server = await device.gatt.connect();

    console.log("Getting service...");
    const service = await server.getPrimaryService(SERVICE_UUID);

    console.log("Getting characteristic...");
    characteristic = await service.getCharacteristic(CHAR_UUID);

    console.log("Starting notifications...");
    await characteristic.startNotifications();

    characteristic.addEventListener(
      "characteristicvaluechanged",
      onPacket
    );

    alert("BLE Connected âœ…");

  } catch (e) {
    console.error("BLE ERROR:", e.name, e.message);
    alert(e.name + ": " + e.message);
  }
}

document.getElementById("connectBtn").onclick = connectBLE;

/* ================= Packet ================= */
function onPacket(e) {
  const v = new Uint8Array(e.target.value.buffer);
  if (v.length !== 20) return;

  pkt = v[19];
}

/* ================= Draw ================= */
function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.fillText("Packet Counter: " + pkt, 40, 60);

  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
